<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>Pretty Fly for a Vuln Risk Evaluator (PFFaRVE)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
    /* Add scaling to make template 75% smaller */
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: auto;
    }
    
    :root {
    /* Dark theme (default) */
    --primary-color: #ff9e2c; /* Brighter Orange for dark theme */
    --secondary-color: #aaaa; /* Light Grey */
    --accent-color: #ff5252; /* Bright Red */
    --bg-color: #121212; /* Very Dark Gray */
    --container-bg: #2d2d2d; /* Dark Gray */
    --text-color: #e0e0e0; /* Light Gray */
    --border-color: #4444; /* Medium Gray */
    --input-bg: #363636; /* Slightly lighter than container */
    }
    /* Light theme variables (will be applied via JS) */
    .light-theme {
    --primary-color: #ff7d00; /* Orange */
    --secondary-color: #5555; /* Dark Grey */
    --accent-color: #e60000; /* Red */
    --bg-color: #f5f5f5; /* Light Gray */
    --container-bg: #ffff; /* White */
    --text-color: #3333; /* Dark Gray */
    --border-color: #dddd; /* Light Gray */
    --input-bg: #f9f9f9; /* Slightly darker than container */
    }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
}

.scroll-container {
    width: 100%;
    height: 100%;
    overflow: auto;
}

.scale-wrapper {
    transform: scale(0.80);
    transform-origin: top left;
    overflow: hidden; /* Restrict overflow locally */
}

.border-danger {
    border: 2px solid #ff5252 !important;
    background-color: rgba(255, 82, 82, 0.1) !important;
}

    body {
    background-color: var(--bg-color);
    color: var(--text-color);
    padding: 20px;
    transition: all 0.3s ease;
    }
    .container {
    max-width: 800px;
    background-color: var(--container-bg);
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    padding: 30px;
    transition: all 0.3s ease;
    }
    h1, h5, h6 {
    color: var(--text-color);
    transition: color 0.3s ease;
    }
    h1 {
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
    }
    .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: #ffff;
    font-weight: 500;
    }
    .btn-primary:hover {
    background-color: #ffb75c;
    border-color: #ffb75c;
    color: #ffff;
    }
    .btn-primary:disabled {
    background-color: #666;
    border-color: #666;
    }
    .form-label {
    color: var(--text-color);
    font-weight: 500;
    transition: color 0.3s ease;
    }
    .form-control {
    background-color: var(--input-bg);
    border-color: var(--border-color);
    color: var(--text-color);
    transition: all 0.3s ease;
    }
    .form-control:focus {
    background-color: var(--input-bg);
    color: var(--text-color);
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(255, 158, 44, 0.25);
    }
    .file-upload {
    border: 2px dashed var(--primary-color);
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
    background-color: rgba(255, 158, 44, 0.1);
    transition: all 0.3s ease;
    position: relative;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    }
    
    /* Enhanced drop zone styles */
    .file-upload.drag-over {
    background-color: rgba(255, 158, 44, 0.3);
    border-style: solid;
    }
    
    .file-upload-text {
    text-align: center;
    margin-bottom: 10px;
    }
    
    .file-upload input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    opacity: 0;
    cursor: pointer;
    }
    
    .file-name {
    margin-top: 10px;
    font-weight: bold;
    word-break: break-all;
    }
    
    .accent-text {
    color: var(--accent-color);
    font-weight: bold;
    }
    .logo-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    transition: border-color 0.3s ease;
    }
    .logo {
    height: 50px;
    margin: 0 10px;
    }
    .mitre-logo-container {
    background-color: #c8102e; /* Red background */
    padding: 5px;
    border-radius: 4px;
    display: inline-block;
    }
    .step-indicator {
    background-color: var(--primary-color);
    color: #ffff;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    margin-right: 10px;
    font-weight: bold;
    transition: background-color 0.3s ease;
    }
    .output-info {
    background-color: rgba(255, 255, 255, 0.05);
    border-left: 4px solid var(--accent-color);
    padding: 15px;
    margin-top: 20px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    }
    .light-theme .output-info {
    background-color: rgba(0, 0, 0, 0.03);
    }
    .alert-secondary {
    background-color: var(--input-bg);
    color: var(--text-color);
    border-color: var(--border-color);
    transition: all 0.3s ease;
    }
    .text-muted {
    color: var(--secondary-color) !important;
    transition: color 0.3s ease;
    }
    .border-top {
    border-top-color: var(--border-color) !important;
    transition: border-color 0.3s ease;
    }
    
    /* Theme toggle styles - moved to bottom right of screen */
    .theme-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    cursor: pointer;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--primary-color);
    color: #000;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    .theme-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
    }
    .theme-toggle svg {
    width: 24px;
    height: 24px;
    transition: all 0.3s ease;
    }
    .moon {
    display: none;
    }
    .light-theme .sun {
    display: none;
    }
    .light-theme .moon {
    display: block;
    }

    /* Processing overlay */
    .processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    }
    
    .processing-content {
    background-color: var(--container-bg);
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    }
    
    .spinner-border {
    color: var(--primary-color);
    }

    /* Results section */
    .results-section {
    display: none;
    margin-top: 30px;
    }
    
    .results-content {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    }
    
    .light-theme .results-content {
    background-color: rgba(0, 0, 0, 0.03);
    }
    
    .download-btn {
    margin: 5px;
    }
    </style>
</head>
<body>
    <div class="scroll-container">
    <div class="scale-wrapper">
    <div class="container mt-5">
    <!-- Logo Container -->
    <div class="logo-container">
    <!-- PFFaRVE Logo Text -->
    <div style="display: flex; align-items: center;">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="PFFaRVE Logo" width="60" height="60" class="logo">
    
    <div style="margin-left: 15px;">
    <h2 style="margin: 0; color: var(--primary-color); font-size: 1.5rem;">PFFaRVE</h2>
    <small style="color: var(--secondary-color);">Pretty Fly for a Vuln Risk Evaluator</small>
    </div>
    </div>

    </div>
    
    <h1 class="mb-4">Vulnerability Risk Assessment</h1>
    
    <div class="alert alert-secondary" role="alert">
    Upload your <span class="accent-text">Severity Classification</span> and <span class="accent-text">AttackIQ JSON Data</span> files to perform AI-powered risk analysis using an LLM model.
    </div>
    
    <div class="mb-4">
    <h5><span class="step-indicator">1</span>Upload Required Files</h5>
    <p>Select your severity criteria and AttackIQ assessment data:</p>
    </div>
    
    <form id="uploadForm" enctype="multipart/form-data">
    <div class="mb-4">
    <label for="severity_file" class="form-label">Severity Classification (Markdown):</label>
    <div class="file-upload" id="severityDropZone">
    <div class="file-upload-text">
    <i class="bi bi-cloud-arrow-up fs-3"></i>
    <p>Drag & drop your severity_rating.md file here<br>or click to browse</p>
    </div>
    <div class="file-name" id="severityFileName"></div>
    <input class="form-control" type="file" id="severity_file" name="severity_file" accept=".md">
    </div>
    <small class="text-muted">Upload the markdown file containing your severity classification criteria</small>
    </div>
    
    <div class="mb-4">
    <label for="json_file" class="form-label">AttackIQ Assessment Data (JSON):</label>
    <div class="file-upload" id="jsonDropZone">
    <div class="file-upload-text">
    <i class="bi bi-cloud-arrow-up fs-3"></i>
    <p>Drag & drop your jira_tickets.json file here<br>or click to browse</p>
    </div>
    <div class="file-name" id="jsonFileName"></div>
    <input class="form-control" type="file" id="json_file" name="json_file" accept=".json">
    </div>
    <small class="text-muted">Upload the JSON file containing AttackIQ assessment results with ticket array structure</small>
    </div>
    
    <div class="output-info">
    <h6><span class="step-indicator">2</span>AI-Powered Risk Analysis</h6>
    <p>After uploading, the system will:</p>
    <ul>
    <li>Send your severity criteria and JSON data to <strong>Claude Sonnet 4</strong> via Abacus.AI</li>
    <li>Analyze each ticket for initial and adjusted severity ratings</li>
    <li>Provide risk factors and mitigating factors for each assessment</li>
    <li>Return both markdown analysis and enhanced JSON with severity_analysis objects</li>
    </ul>
    <div class="mt-3 p-3" style="background-color: rgba(255, 158, 44, 0.1); border-radius: 5px;">
    <strong><i class="bi bi-info-circle"></i> Configuration Required:</strong>
    <p class="mb-0 mt-2">Ensure your <code>config.json</code> file contains valid Abacus.AI API credentials before processing.</p>
    </div>
    </div>
    
    <div class="d-grid gap-2 mt-4">
    <button type="submit" class="btn btn-primary btn-lg" id="processBtn">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cpu me-2" viewBox="0 0 16 16">
    <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 13.5 4.5H15a.5.5 0 0 1 0 1h-1.5v1H15a.5.5 0 0 1 0 1h-1.5v1H15a.5.5 0 0 1 0 1h-1.5v1H15a.5.5 0 0 1 0 1h-1.5a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2.5 11.5H1a.5.5 0 0 1 0-1h1.5v-1H1a.5.5 0 0 1 0-1h1.5v-1H1a.5.5 0 0 1 0-1h1.5v-1H1a.5.5 0 0 1 0-1h1.5A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0zm-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3h-7zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
    </svg>
    Analyze
    </button>
    </div>
    </form>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
    <h5><span class="step-indicator">3</span>Analysis Results</h5>
    <div class="results-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h6><i class="bi bi-check-circle-fill text-success"></i> Processing Complete</h6>
    <div>
    <button class="btn btn-outline-primary btn-sm download-btn" id="downloadAnalysis">
    <i class="bi bi-download"></i> Analysis (MD)
    </button>
    <button class="btn btn-outline-primary btn-sm download-btn" id="downloadJson">
    <i class="bi bi-download"></i> Enhanced JSON
    </button>
    </div>
    </div>
    <div id="analysisPreview" style="max-height: 400px; overflow-y: auto; background-color: rgba(0,0,0,0.1); padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
    <!-- Analysis preview will be inserted here -->
    </div>
    </div>
    
    <!-- Footer -->
    <div class="mt-5 pt-3 border-top text-center">
    <p class="text-muted small">PFFaRVE processes AttackIQ data using AI-powered risk analysis via Abacus.AI and Claude Sonnet 4</p>
    </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
    <div class="processing-content">
    <div class="spinner-border mb-3" role="status">
    <span class="visually-hidden">Loading...</span>
    </div>
    <h5>Analyzing with Claude Sonnet 4...</h5>
    <p class="text-muted">This may take a few minutes depending on the size of your data.</p>
    <div class="progress mt-3">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
    </div>
    </div>
    </div>

    <!-- Theme toggle button -->
    <div class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode">
    <!-- Sun icon (shown in dark mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <!-- Moon icon (shown in light mode) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const html = document.documentElement;
    
    const currentTheme = localStorage.getItem('theme') || 'dark';
    if (currentTheme === 'light') {
    body.classList.add('light-theme');
    html.setAttribute('data-bs-theme', 'light');
    }
    
    themeToggle.addEventListener('click', function() {
    body.classList.toggle('light-theme');
    const isDark = !body.classList.contains('light-theme');
    html.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // File upload handling
    const form = document.getElementById('uploadForm');
    const severityInput = document.getElementById('severity_file');
    const jsonInput = document.getElementById('json_file');
    const severityDropZone = document.getElementById('severityDropZone');
    const jsonDropZone = document.getElementById('jsonDropZone');
    const severityFileName = document.getElementById('severityFileName');
    const jsonFileName = document.getElementById('jsonFileName');
    const processBtn = document.getElementById('processBtn');
    const processingOverlay = document.getElementById('processingOverlay');
    const resultsSection = document.getElementById('resultsSection');

    // Store analysis results
    let analysisResults = null;

    // File input change handlers
    severityInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
    severityFileName.textContent = this.files[0].name;
    severityDropZone.classList.remove('border-danger');
    } else {
    severityFileName.textContent = '';
    }
    });

    jsonInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
    jsonFileName.textContent = this.files[0].name;
    jsonDropZone.classList.remove('border-danger');
    } else {
    jsonFileName.textContent = '';
    }
    });

    // Drag and drop functionality
    function setupDragDrop(dropZone, input) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, function() {
    this.classList.add('drag-over');
    }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, function() {
    this.classList.remove('drag-over');
    }, false);
    });

    dropZone.addEventListener('drop', function(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files && files.length) {
    input.files = files;
    const event = new Event('change', { bubbles: true });
    input.dispatchEvent(event);
    }
    }, false);
    }

    setupDragDrop(severityDropZone, severityInput);
    setupDragDrop(jsonDropZone, jsonInput);

    // Form submission
    form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    let valid = true;
    
    // Reset error styling
    severityDropZone.classList.remove('border-danger');
    jsonDropZone.classList.remove('border-danger');
    
    // Validate files
    if (!severityInput.files || !severityInput.files[0]) {
    severityDropZone.classList.add('border-danger');
    valid = false;
    }
    
    if (!jsonInput.files || !jsonInput.files[0]) {
    jsonDropZone.classList.add('border-danger');
    valid = false;
    }
    
    if (!valid) {
    // Pulse animation for invalid inputs
    const invalidInputs = document.querySelectorAll('.border-danger');
    invalidInputs.forEach(el => {
    el.style.animation = 'none';
    setTimeout(() => {
    el.style.animation = 'pulse 1s ease';
    }, 10);
    });
    return;
    }

    // Show processing overlay
    processingOverlay.style.display = 'flex';
    processBtn.disabled = true;

    // Prepare form data
    const formData = new FormData();
    formData.append('severity_file', severityInput.files[0]);
    formData.append('json_file', jsonInput.files[0]);

    // Submit to Flask backend
    fetch('/analyze', {
    method: 'POST',
    body: formData
    })
    .then(response => response.json())
    .then(data => {
    processingOverlay.style.display = 'none';
    processBtn.disabled = false;

    if (data.success) {
    analysisResults = data;
    showResults(data);
    } else {
    alert('Error: ' + (data.error || 'Unknown error occurred'));
    }
    })
    .catch(error => {
    processingOverlay.style.display = 'none';
    processBtn.disabled = false;
    console.error('Error:', error);
    alert('Network error: ' + error.message);
    });
    });

    function showResults(data) {
    const analysisPreview = document.getElementById('analysisPreview');

    // Use analysis_preview instead of analysis
    const previewText = data.analysis_preview || 'No preview available';
    analysisPreview.textContent = previewText;

    // Store the response data for downloads
    analysisResults = data;

    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Download handlers
    document.getElementById('downloadAnalysis').addEventListener('click', function() {
    if (analysisResults && analysisResults.markdown_file) {
        // Use the backend download endpoint
        window.open(`/download/markdown/${encodeURIComponent(analysisResults.markdown_file.split('/').pop())}`, '_blank');
    }
    });

    document.getElementById('downloadJson').addEventListener('click', function() {
    if (analysisResults && analysisResults.json_file) {
        // Use the backend download endpoint
        window.open(`/download/json/${encodeURIComponent(analysisResults.json_file.split('/').pop())}`, '_blank');
    }
    });

    function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    }
});
    </script>
</div>
</div>
</body>
</html>